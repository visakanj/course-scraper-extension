<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Migration POC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <!-- Main Title -->
            <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">Course Migration POC</h1>

            <!-- Subtitle -->
            <h2 class="text-lg text-gray-600 text-center mb-8">Step 1: Fetch Course Data from Thinkific</h2>

            <!-- Input Fields -->
            <div class="space-y-6 mb-8">
                <div>
                    <label for="subdomain" class="block text-sm font-medium text-gray-700 mb-2">Thinkific Subdomain</label>
                    <input
                        type="text"
                        id="subdomain"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="your-subdomain"
                    >
                </div>

                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">Thinkific API Key</label>
                    <input
                        type="password"
                        id="apiKey"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Your API key"
                    >
                </div>
            </div>

            <!-- Fetch Courses Button -->
            <button
                id="fetchCoursesBtn"
                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 mb-8"
            >
                Fetch Courses
            </button>

            <!-- Course Selection Section (Hidden) -->
            <div id="courseSelection" class="hidden space-y-6 mb-8">
                <div>
                    <label for="courseSelect" class="block text-sm font-medium text-gray-700 mb-2">Select a Course</label>
                    <select
                        id="courseSelect"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">Choose a course...</option>
                    </select>
                </div>

                <button
                    id="generatePlanBtn"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-md font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200"
                >
                    Generate Migration Plan
                </button>
            </div>

            <!-- JSON Output Section (Hidden) -->
            <div id="jsonOutput" class="hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Migration Plan JSON:</h3>
                <pre id="jsonDisplay" class="bg-gray-100 p-4 rounded-md overflow-auto text-sm border max-h-96"></pre>
            </div>

            <!-- Status Message Area -->
            <div id="statusMessage" class="mt-8 p-4 rounded-md hidden"></div>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const THINKIFIC_API_BASE = 'https://api.thinkific.com/api/public/v1';

        let subdomain = '';
        let apiKey = '';
        let courses = [];

        // DOM Elements
        const subdomainInput = document.getElementById('subdomain');
        const apiKeyInput = document.getElementById('apiKey');
        const fetchCoursesBtn = document.getElementById('fetchCoursesBtn');
        const courseSelection = document.getElementById('courseSelection');
        const courseSelect = document.getElementById('courseSelect');
        const generatePlanBtn = document.getElementById('generatePlanBtn');
        const jsonOutput = document.getElementById('jsonOutput');
        const jsonDisplay = document.getElementById('jsonDisplay');
        const statusMessage = document.getElementById('statusMessage');

        // Utility Functions
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `mt-8 p-4 rounded-md ${
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        async function makeApiRequest(endpoint, headers = {}) {
            const url = `${CORS_PROXY}${THINKIFIC_API_BASE}${endpoint}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Auth-API-Key': apiKey,
                    'X-Auth-Subdomain': subdomain,
                    'Content-Type': 'application/json',
                    ...headers
                }
            });

            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Access forbidden. Please ensure your API credentials are correct and activate the CORS proxy at https://cors-anywhere.herokuapp.com/corsdemo');
                }
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }

            return await response.json();
        }

        // Event Handlers
        fetchCoursesBtn.addEventListener('click', async () => {
            subdomain = subdomainInput.value.trim();
            apiKey = apiKeyInput.value.trim();

            if (!subdomain || !apiKey) {
                showStatus('Please enter both subdomain and API key.', 'error');
                return;
            }

            try {
                fetchCoursesBtn.disabled = true;
                fetchCoursesBtn.textContent = 'Fetching...';
                showStatus('Fetching courses from Thinkific...', 'info');

                const response = await makeApiRequest('/courses');
                courses = response.items || [];

                // Populate course dropdown
                courseSelect.innerHTML = '<option value="">Choose a course...</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });

                courseSelection.classList.remove('hidden');
                showStatus(`Successfully fetched ${courses.length} courses!`, 'success');

            } catch (error) {
                console.error('Error fetching courses:', error);
                showStatus(error.message, 'error');
            } finally {
                fetchCoursesBtn.disabled = false;
                fetchCoursesBtn.textContent = 'Fetch Courses';
            }
        });

        generatePlanBtn.addEventListener('click', async () => {
            const selectedCourseId = courseSelect.value;

            if (!selectedCourseId) {
                showStatus('Please select a course.', 'error');
                return;
            }

            const selectedCourse = courses.find(course => course.id == selectedCourseId);

            try {
                generatePlanBtn.disabled = true;
                generatePlanBtn.textContent = 'Generating...';
                showStatus('Generating migration plan...', 'info');

                // Step 1: Fetch chapters for the selected course
                const chaptersResponse = await makeApiRequest(`/courses/${selectedCourseId}/chapters`);
                const chapters = chaptersResponse.items || [];

                const migrationPlan = {
                    course_name: selectedCourse.name,
                    modules: []
                };

                // Step 2: For each chapter, fetch its contents
                for (const chapter of chapters) {
                    showStatus(`Processing chapter: ${chapter.name}...`, 'info');

                    const contentsResponse = await makeApiRequest(`/chapters/${chapter.id}/contents`);
                    const contents = contentsResponse.items || [];

                    const module = {
                        module_title: chapter.name,
                        lessons: []
                    };

                    // Step 3: For each content item that is a Text lesson, fetch its details
                    for (const content of contents) {
                        if (content.contentable_type === 'Text') {
                            try {
                                const contentDetails = await makeApiRequest(`/contents/${content.id}`);

                                const lesson = {
                                    lesson_title: content.name,
                                    lesson_text: contentDetails.text || contentDetails.content || 'No text content available'
                                };

                                module.lessons.push(lesson);
                            } catch (error) {
                                console.warn(`Failed to fetch content details for ${content.name}:`, error);
                                // Include lesson even if we can't fetch full details
                                const lesson = {
                                    lesson_title: content.name,
                                    lesson_text: 'Content details could not be retrieved'
                                };
                                module.lessons.push(lesson);
                            }
                        }
                    }

                    migrationPlan.modules.push(module);
                }

                // Display the final JSON
                jsonDisplay.textContent = JSON.stringify(migrationPlan, null, 2);
                jsonOutput.classList.remove('hidden');
                showStatus('Plan Generated!', 'success');

            } catch (error) {
                console.error('Error generating migration plan:', error);
                showStatus(error.message, 'error');
            } finally {
                generatePlanBtn.disabled = false;
                generatePlanBtn.textContent = 'Generate Migration Plan';
            }
        });
    </script>
</body>
</html>